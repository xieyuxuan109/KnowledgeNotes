Markdown
# Kubernetes v1.32.0 生产级环境部署手册 (Ubuntu 24.04)

本文档记录了在三台 Ubuntu 24.04 机器上，将预装的 v1.34 降级并成功构建 v1.32.0 集群的全过程。

---

## 1. 节点信息预设

| 主机名 | IP 地址 | 角色 |
| :--- | :--- | :--- |
| **k8s-master** | 192.168.1.222 | 控制平面 (Control Plane) |
| **k8s-node1** | 192.168.1.223 | 工作节点 (Worker Node) |
| **k8s-node2** | 192.168.1.224 | 工作节点 (Worker Node) |

---

## 2. 基础环境准备 (所有节点执行)

### 2.1 软件版本降级与锁定
由于官方仓库默认版本较高，需强制指定 v1.32.0 并锁定版本防止自动更新。

```bash
# 1. 更新索引并安装指定版本
sudo apt-get update
sudo apt-get install -y --allow-downgrades \
  kubeadm=1.32.0-1.1 \
  kubelet=1.32.0-1.1 \
  kubectl=1.32.0-1.1

# 2. 锁定版本
sudo apt-mark hold kubeadm kubelet kubectl
2.2 禁用 Swap (K8s 硬性要求)
Bash
sudo swapoff -a
sudo sed -i '/swap/s/^/#/' /etc/fstab
2.3 修正 Containerd 配置 (关键)
修复 Cgroup 驱动不一致导致的 API Server 无法启动问题。

Bash
# 生成默认配置
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null

# 开启 SystemdCgroup 并修正 Pause 镜像地址
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo sed -i 's|registry.k8s.io/pause:3.8|[registry.aliyuncs.com/google_containers/pause:3.10](https://registry.aliyuncs.com/google_containers/pause:3.10)|g' /etc/containerd/config.toml

# 重启容器运行时
sudo systemctl restart containerd
sudo systemctl enable --now containerd
3. 集群初始化 (仅在 k8s-master 执行)
执行初始化命令，使用国内阿里云镜像加速。

Bash
sudo kubeadm init \
  --kubernetes-version=v1.32.0 \
  --apiserver-advertise-address=192.168.1.222 \
  --image-repository [registry.aliyuncs.com/google_containers](https://registry.aliyuncs.com/google_containers) \
  --pod-network-cidr=10.244.0.0/16
3.1 配置管理员访问权限
Bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
3.2 部署 Flannel 网络插件
Bash
kubectl apply -f [https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml](https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml)
4. 节点加入集群 (在 k8s-node1 和 k8s-node2 执行)
使用 Master 初始化成功后生成的 Token 加入集群。

Bash
sudo kubeadm join 192.168.1.222:6443 --token 3kj5w3.e26zpbltbgg0h5k9 \
    --discovery-token-ca-cert-hash sha256:7b9fbd22cee2166c997f5ceb90a5190c7c546ee95f20722ae570ac6de19b3153
5. 验证与测试 (在 k8s-master 执行)
5.1 查看节点状态
Bash
kubectl get nodes
期望结果：

Plaintext
NAME         STATUS   ROLES           AGE    VERSION
k8s-master   Ready    control-plane   10m    v1.32.0
k8s-node1    Ready    <none>          5m     v1.32.0
k8s-node2    Ready    <none>          5m     v1.32.0
5.2 查看系统组件状态
Bash
kubectl get pods -A
确保 kube-flannel 和 coredns 均处于 Running 状态。

5.3 快速部署 Nginx 测试
Bash
# 部署 Nginx
kubectl create deployment nginx-test --image=nginx:alpine --replicas=2
# 暴露服务
kubectl expose deployment nginx-test --port=80 --type=NodePort
# 查看访问端口
kubectl get svc
6. 常见故障排查
查看 Kubelet 日志: journalctl -xeu kubelet

查看容器日志: kubectl logs <pod-name> -n <namespace>

彻底重置环境: sudo kubeadm reset -f && sudo rm -rf /etc/cni/net.d


这份文档现在涵盖了从零到 Ready 的所有环节。你还需要我为你生成一份用于 NodePort 访问或 ingress